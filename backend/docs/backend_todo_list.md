# 《五日勇者》后端开发 TODO 清单

## 概述
基于当前代码分析，整理出后端需要开发和完善的功能模块。项目已有基础的API架构、LLM集成和剧情推演引擎，但还需要完善数据持久化、游戏状态管理、完整的游戏流程等核心功能。

---

## 🔥 高优先级 (核心功能)

### 1. 数据持久化系统
**状态**: ❌ 未实现
**描述**: 目前所有数据都是临时的，需要实现完整的数据存储方案

#### 1.1 文件存储架构设计
- [ ] **存储方案**: 基于JSON文件的轻量级存储
- [ ] **文件结构**: 每个游戏会话对应一个JSON文件
- [ ] **数据存储位置**: `backend/data/games/`
- [ ] **备份策略**: 简单的文件复制备份

#### 1.2 文件命名和结构设计
- [ ] **文件命名规则**: `{session_id}.json`
- [ ] **示例**: `game_123e4567-e89b-12d3-a456-426614174000.json`
- [ ] **JSON文件结构**:
  ```json
  {
    "session_info": {
      "session_id": "game_xxx-xxx-xxx",
      "created_at": "2024-01-01T10:00:00Z",
      "expires_at": "2024-01-08T10:00:00Z",
      "last_accessed": "2024-01-01T15:30:00Z",
      "is_active": true
    },
    "game_state": {
      "current_day": 1,
      "current_time": "上午",
      "world_state": {
        "weather": "晴天",
        "atmosphere": "平静",
        "locations": {}
      }
    },
    "characters": {
      "hero": {
        "basic_info": {},
        "stats": {},
        "equipment": {},
        "inventory": []
      },
      "npcs": {
        "村长": {},
        "铁匠": {}
      }
    },
    "relationships": {
      "勇者->村长": 5,
      "勇者->铁匠": 0
    },
    "history": [
      {
        "day": 1,
        "time": "上午",
        "event": "勇者来到村庄",
        "timestamp": "2024-01-01T10:00:00Z"
      }
    ]
  }
  ```

#### 1.3 文件生命周期管理
- [ ] **7天有效期机制**
  - 文件创建时设置 `expires_at = created_at + 7天`
  - 每次访问更新 `last_accessed` 时间
  - 定时清理任务删除过期文件
- [ ] **自动清理系统**
  - 实现定时任务扫描过期文件
  - 删除过期的JSON文件
  - 清理空目录和临时文件
  - 文件大小监控和日志记录

#### 1.4 文件操作层实现
- [ ] 创建 `services/file_storage_service.py` - 文件存储服务
- [ ] 创建 `services/game_data_service.py` - 游戏数据服务层
- [ ] 创建 `utils/file_utils.py` - 文件操作工具函数
- [ ] 创建 `utils/json_utils.py` - JSON序列化工具

### 2. 用户会话管理系统
**状态**: ❌ 未实现
**描述**: 基于游戏ID的会话管理，无需用户注册登录

#### 2.1 会话生成和管理
- [ ] **游戏ID生成机制**
  - 使用UUID4生成唯一游戏ID
  - 格式: `game_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
  - 确保ID的唯一性和不可预测性
- [ ] **会话创建流程**
  - 玩家开始新游戏时生成session_id
  - 初始化游戏状态数据
  - 设置7天过期时间
  - 返回session_id给前端
- [ ] **会话验证机制**
  - 每次API调用验证session_id有效性
  - 检查会话是否过期
  - 更新最后访问时间

#### 2.2 会话文件管理
- [ ] **会话中间件**
  - 创建Flask中间件验证session_id
  - 自动检查对应JSON文件是否存在
  - 验证文件是否过期
  - 统一的会话错误处理
- [ ] **会话API接口**
  - `POST /api/session/create` - 创建新游戏会话和JSON文件
  - `GET /api/session/{session_id}/status` - 检查会话状态和文件有效性
  - `DELETE /api/session/{session_id}` - 删除会话文件
  - `GET /api/session/{session_id}/info` - 获取会话基本信息

#### 2.3 文件访问控制
- [ ] **文件安全访问**
  - 所有文件操作必须基于有效的session_id
  - 防止路径遍历攻击 (../等)
  - 文件名格式验证
  - 文件读写权限控制
- [ ] **文件清理机制**
  - 定时任务扫描并删除过期文件
  - 清理临时文件和备份文件
  - 文件操作日志记录

### 3. 完整的游戏状态管理
**状态**: 🟡 部分实现
**描述**: 当前只有基础的状态模型，需要完善游戏状态的完整生命周期管理
- [ ] 实现游戏状态的统一管理类 `GameStateManager`
- [ ] 完善时间推进系统 (5天游戏流程)
- [ ] 实现状态变化的历史记录
- [ ] ~~添加状态回滚功能~~ (不需要存档系统)
- [ ] 完善角色关系图的持久化
- [ ] **基于JSON文件的状态管理**
  - 所有状态操作都关联到特定JSON文件
  - 实现状态的增量更新和文件写入
  - 文件操作的原子性保证 (临时文件+重命名)
  - JSON数据的版本控制和备份

### 4. 核心游戏流程API
**状态**: 🟡 部分实现
**描述**: 游戏的主要流程接口需要完善
- [ ] 完善 `/api/game/action` 接口，集成LLM推演
- [ ] 实现每日行动处理逻辑
- [ ] 添加游戏结束条件判断
- [ ] 实现多种结局系统
- [ ] 添加游戏进度检查点
- [ ] **基于JSON文件的游戏流程**
  - 所有游戏操作都需要有效的session_id和对应文件
  - 游戏状态的实时文件保存
  - 支持游戏中断和恢复 (7天内)
  - 游戏进度的文件备份机制

### 5. 角色互动系统
**状态**: 🟡 部分实现
**描述**: NPC互动和关系系统需要完善
- [ ] 完善NPC对话系统
- [ ] 实现动态关系值计算
- [ ] 添加角色事件触发机制
- [ ] 实现角色状态的动态更新
- [ ] 完善角色AI行为模式
- [ ] **文件化角色数据**
  - 角色状态变化的实时文件保存
  - 关系值变化的历史记录 (存储在JSON中)
  - 基于session_id的角色数据文件隔离

---

## 🟠 中优先级 (重要功能)

### 6. 地点和场景系统
**状态**: 🟡 部分实现  
**描述**: 需要完善地点管理和场景切换
- [ ] 实现完整的地点模型 `LocationModel`
- [ ] 添加地点间的移动逻辑
- [ ] 实现场景特殊事件系统
- [ ] 添加地点状态的动态变化
- [ ] 完善地点相关的API接口

### 7. 事件系统增强
**状态**: 🟡 部分实现  
**描述**: 当前事件系统较简单，需要增强
- [ ] 实现事件触发条件系统
- [ ] 添加随机事件生成
- [ ] 完善事件链和事件依赖
- [ ] 实现事件的延迟触发
- [ ] 添加事件影响的量化计算

### 8. 装备和物品系统
**状态**: 🟡 部分实现  
**描述**: 基础装备系统已有，需要完善
- [ ] 实现物品效果系统
- [ ] 添加装备属性加成计算
- [ ] 完善物品获取和丢失逻辑
- [ ] 实现特殊物品的功能
- [ ] 添加物品相关的API接口

### 9. 战斗系统 (如果需要)
**状态**: ❌ 未实现  
**描述**: 根据游戏设计可能需要简单的战斗系统
- [ ] 设计战斗逻辑
- [ ] 实现属性对战斗的影响
- [ ] 添加战斗结果的状态更新
- [ ] 集成战斗到剧情推演中

---

## 🟡 低优先级 (优化功能)

### 10. API性能优化
**状态**: 🟡 需要优化  
**描述**: 当前API响应可能较慢，需要优化
- [ ] 添加API响应缓存
- [ ] 优化LLM调用频率
- [ ] 实现异步处理机制
- [ ] 添加API限流保护
- [ ] 优化数据库查询性能

### 11. 错误处理和日志
**状态**: 🟡 部分实现  
**描述**: 需要完善错误处理和监控
- [ ] 完善全局异常处理
- [ ] 添加详细的错误码系统
- [ ] 增强日志记录的详细程度
- [ ] 实现错误报告和监控
- [ ] 添加性能监控指标

### 12. 配置管理
**状态**: 🟡 部分实现  
**描述**: 需要更好的配置管理
- [ ] 实现配置文件的热重载
- [ ] 添加环境变量的验证
- [ ] 完善游戏平衡性参数配置
- [ ] 实现配置的版本管理

### 13. 测试覆盖
**状态**: 🟡 部分实现  
**描述**: 需要完善测试用例
- [ ] 添加单元测试覆盖
- [ ] 实现集成测试
- [ ] 添加API自动化测试
- [ ] 实现性能测试
- [ ] 添加LLM响应的测试

---

## 🔧 技术债务

### 14. 代码重构
**状态**: 🟡 需要改进  
**描述**: 一些代码需要重构以提高可维护性
- [ ] 重构重复的NPC生成代码 (world_api.py 和 npc_api.py)
- [ ] 统一错误处理模式
- [ ] 优化导入结构
- [ ] 添加类型注解
- [ ] 完善文档字符串

### 15. 安全性增强
**状态**: 🟡 需要加强  
**描述**: 需要加强API安全性
- [ ] 添加输入验证和清理
- [ ] 实现API认证机制
- [ ] 添加CSRF保护
- [ ] 实现请求频率限制
- [ ] 加强敏感数据保护

---

## 📋 具体实现建议

### 优先实现顺序
1. **数据持久化系统** - 这是所有其他功能的基础
2. **用户会话管理** - 基于游戏ID的会话系统
3. **游戏状态管理** - 确保游戏流程的完整性
4. **核心游戏流程API** - 让游戏能够正常运行
5. **角色互动系统** - 提升游戏体验
6. **其他功能** - 根据需要逐步完善

### 技术选型建议
- **存储方案**: JSON文件 (轻量级，易于调试和修改)
- **文件操作**: Python内置json模块 + 文件锁
- **会话ID**: UUID4 (保证唯一性和安全性)
- **定时任务**: APScheduler (轻量级任务调度)
- **文件安全**: 原子写入 (临时文件+重命名)
- **备份**: 简单文件复制，无需复杂备份策略

### 开发里程碑
- **第一阶段**: 完成文件存储和会话管理 (1-2周)
  - JSON文件存储系统
  - 文件目录结构创建
  - 游戏ID生成和会话管理
  - 7天过期文件清理机制
- **第二阶段**: 完善游戏状态管理和核心流程 (2-3周)
  - 游戏状态的JSON文件化
  - 基于session_id的文件隔离
  - 核心游戏流程API完善
- **第三阶段**: 完善角色系统和事件系统 (2-3周)
  - 角色数据文件化
  - 关系图系统完善
  - 事件系统增强
- **第四阶段**: 优化性能和完善测试 (1-2周)
  - 性能优化
  - 测试覆盖
  - 错误处理完善

---

## 📝 备注
- 当前项目已有良好的基础架构，主要缺少数据持久化和完整的游戏流程
- LLM集成和剧情推演引擎已经实现，是项目的亮点
- **无存档系统**: 游戏采用单次游玩模式，7天内可中断恢复，过期自动清理
- **轻量级设计**: 使用JSON文件存储，无需数据库服务，易于调试和修改
- **会话管理**: 基于UUID的游戏ID，无需用户注册登录
- 建议优先完成核心功能，再逐步完善辅助功能
- 需要根据前端需求调整API接口的设计

## 🗂️ 文件存储结构建议
```
backend/
├── data/
│   ├── games/                # 游戏数据目录
│   │   ├── game_xxx-xxx-xxx.json  # 游戏会话文件
│   │   ├── game_yyy-yyy-yyy.json  # 另一个游戏会话
│   │   └── ...
│   ├── backups/              # 备份目录
│   │   ├── 2024-01-01/       # 按日期备份
│   │   └── ...
│   └── logs/                 # 文件操作日志
├── services/
│   ├── file_storage_service.py    # 文件存储服务
│   ├── game_data_service.py       # 游戏数据服务
│   ├── session_service.py         # 会话管理服务
│   └── ...
└── utils/
    ├── file_utils.py         # 文件操作工具
    ├── json_utils.py         # JSON处理工具
    └── cleanup_tasks.py      # 定时清理任务
```

## 🔧 实现细节补充

### 会话ID格式设计
- **格式**: `game_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **示例**: `game_123e4567-e89b-12d3-a456-426614174000`
- **优势**:
  - 易于识别为游戏会话
  - UUID保证唯一性
  - 不可预测，提高安全性

### 7天过期机制
- **创建时**: JSON文件中设置 `expires_at = created_at + timedelta(days=7)`
- **访问时**: 更新文件中的 `last_accessed` 字段
- **清理时**: 定时任务扫描文件，删除过期的JSON文件
- **提醒**: API返回剩余有效时间

### 文件安全策略
- 每个游戏会话对应独立的JSON文件
- API中间件自动验证session_id和文件存在性
- 文件名格式严格验证，防止路径遍历
- 原子写入操作，防止文件损坏

### JSON文件操作最佳实践
- **原子写入**: 先写临时文件，再重命名
- **文件锁**: 防止并发写入冲突
- **备份机制**: 重要操作前自动备份
- **错误恢复**: 文件损坏时的恢复策略
- **性能优化**: 增量更新，避免全文件重写
